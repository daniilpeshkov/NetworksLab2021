# NetworksLab2021

## Описание прикладного протокола

Прикладной протокол состоит из двух слоёв: первый слой позволяет упаковать различные данные в одно сообщение, разделив их по тегам. Второй слой — непосредственно то, как сервер использует эти теги (какие данные и в каком формате передаёт под определёнными тегами) — протокол общения.
### Формат сообщения
![Формат сообщения](/images/simpleTcpMessage.drawio.png)

Каждое сообщение состоит из 1-ого и более кадров. Каждый кадр состоит из заголовка (2 байта) и  данных (от 0 до 255 байт).
Первый байт заголовка содержит флаг hasNext и поле Tag. Флаг hasNext показывает будет ли за этим кадром ещё один или же это конец сообщения. Поле Tag указывает тег передаваемых данных. Несколько кадров могут иметь одинаковый тег — на принимающей стороне эти данные будут последовательно записаны в один буфер.
Второй байт заголовка — DLC (Data Length Code) — длинна данных в текущем кадре в байтах (от 0 до 255). 

### Протокол общения

Протокол определяет 6 тегов:
- TagSys (1)
- TagMessage (2)
- TagFileName (3)
- TagFile (4)
- TagTime (5)
- TagName (6)

Тег TagSys содержит информацию о типе сообщения и прочую системную информацию. Преднозначение остальных тегов понятно по названию.
TagTime и TagName задаются только сервером (кроме запроса на регистрацию). 
TagTime содержится в каждом ответе от сервера.

#### Формат поля TagSys

Первый байт поля TagSys всегда содержит идентификатор сообщения. На данный момент их имеется 4:
- SysLoginRequest (1)
- SysUserLoginNotification (3) 
- SysMessage (4)
- SysFile (5)

Остальные байты в поле TagSys опциональны и определяются типом сообщения (первый байт).
Далее будут рассмотрены все типы сообщений.

#### SysLoginRequest
Запрос на регистрацию на сервере. До регистрации, все отправляемые сообщения будут игнорироваться, однако TCP соединения разрываться не будет.
Данное сообщение должно содержать TagName со строкой с именем в формате UTF-8.
В ответе от сервера второй байт TagSys будет содержать код ответа:

- LOGIN_OK (1) — регистрация успешна
- NAME_USED(2) или NAME_WRONG_FORMAT(3) — имя занято или не удовлетворяет требованиям сервера

#### SysUserLoginNotification

Данный тип сообщения отправляет только сервер и содержит информацию об отключении или подключении пользователя.
Второй байт TagSys содержит статус:

- USER_CONNECTED (1)
- USER_DISCONNECTED (2)

TagName содержит имя пользователя.

#### SysMessage

Данный тип указывается при отправке текстового сообщения. Должен содержать TagMessage с текстом сообщение в UTF-8.
Отправляющий получает в ответ сообщение содержащее только TagSys, в котором второй байт указывает статус отправки:

- MESSAGE_SENT (1)
- MESSAGE_WRONG_FORMAT (2)

Могут быть добавлены другие идентификаторы, так как на данный момент не отправляется ничего, кроме MESSAGE_SENT.

После отправки остальные пользователи получают сообщение от сервера содержащее: TagSys (SysMessage), TagName (имя пользователя, отправившего сообщение), TagTime.

#### SysFile

Аналогично SysMessage, только вместо TagMessage должен содержать TagFileName (имя файла в UTF-8) и TagFile (сам файл) 

В ответ придёт FILE_SENT (1), если отправка прошла успешно.









